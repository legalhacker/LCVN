generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  editor
}

enum ChangeType {
  amendment
  addition
  first_codification
}

enum ChangeStatus {
  draft
  published
}

enum DocumentType {
  luat
  nghi_dinh
  thong_tu
  quyet_dinh
}

enum DocumentStatus {
  active
  amended
  repealed
}

enum EntityType {
  document
  article
  clause
  point
}

enum RelationshipType {
  amended_by
  replaces
  related_to
  references
  implements
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.Text
  name         String?  @db.VarChar(255)
  role         UserRole @default(editor)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("users")
}

model Field {
  id                String                 @id @default(uuid()) @db.Uuid
  name              String                 @db.VarChar(255)
  slug              String                 @unique @db.VarChar(255)
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  regulatoryChanges RegulatoryChangeField[]

  @@map("fields")
}

model RegulatoryChange {
  id               String                 @id @default(uuid()) @db.Uuid
  slug             String                 @unique @db.VarChar(255)
  lawName          String                 @map("law_name") @db.Text
  changeType       ChangeType             @map("change_type")
  legalBasis       String                 @map("legal_basis") @db.Text
  source           String                 @db.Text
  effectiveDate    DateTime               @map("effective_date") @db.Date
  headline         String                 @db.Text
  summary          String                 @db.Text
  practicalImpact  String[]               @map("practical_impact")
  affectedParties  String[]               @map("affected_parties")
  analysisSummary  String?                @map("analysis_summary") @db.Text
  comparisonBefore String?                @map("comparison_before") @db.Text
  comparisonAfter  String?                @map("comparison_after") @db.Text
  timeline         String?                @db.Text
  context          String?                @db.Text
  status           ChangeStatus           @default(draft)
  legalDocumentId  String?                @map("legal_document_id") @db.Uuid
  legalDocument    LegalDocument?         @relation(fields: [legalDocumentId], references: [id], onDelete: SetNull)
  fields           RegulatoryChangeField[]
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")

  @@map("regulatory_changes")
}

model RegulatoryChangeField {
  regulatoryChangeId String           @map("regulatory_change_id") @db.Uuid
  fieldId            String           @map("field_id") @db.Uuid
  regulatoryChange   RegulatoryChange @relation(fields: [regulatoryChangeId], references: [id], onDelete: Cascade)
  field              Field            @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@id([regulatoryChangeId, fieldId])
  @@map("regulatory_change_fields")
}

model LegalDocument {
  id             String         @id @default(uuid()) @db.Uuid
  canonicalId    String         @unique @map("canonical_id") @db.VarChar(100)
  title          String         @db.Text
  documentNumber String         @map("document_number") @db.VarChar(50)
  documentType   DocumentType   @map("document_type")
  issuingBody    String         @map("issuing_body") @db.Text
  issuedDate     DateTime       @map("issued_date") @db.Date
  effectiveDate  DateTime       @map("effective_date") @db.Date
  slug           String         @unique @db.VarChar(200)
  year           Int
  status         DocumentStatus @default(active)
  articles          Article[]
  regulatoryChanges RegulatoryChange[]
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")

  @@map("legal_documents")
}

model Article {
  id            String        @id @default(uuid()) @db.Uuid
  canonicalId   String        @unique @map("canonical_id") @db.VarChar(100)
  documentId    String        @map("document_id") @db.Uuid
  articleNumber Int           @map("article_number")
  title         String?       @db.Text
  content       String        @db.Text
  chapter       String?       @db.VarChar(100)
  section       String?       @db.VarChar(100)
  document      LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  clauses       Clause[]
  createdAt     DateTime      @default(now()) @map("created_at")
  updatedAt     DateTime      @updatedAt @map("updated_at")

  @@unique([documentId, articleNumber])
  @@index([documentId])
  @@map("articles")
}

model Clause {
  id           String   @id @default(uuid()) @db.Uuid
  canonicalId  String   @unique @map("canonical_id") @db.VarChar(100)
  articleId    String   @map("article_id") @db.Uuid
  clauseNumber Int      @map("clause_number")
  content      String   @db.Text
  article      Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  points       Point[]
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@unique([articleId, clauseNumber])
  @@index([articleId])
  @@map("clauses")
}

model Point {
  id          String   @id @default(uuid()) @db.Uuid
  canonicalId String   @unique @map("canonical_id") @db.VarChar(100)
  clauseId    String   @map("clause_id") @db.Uuid
  pointLetter String   @map("point_letter") @db.Char(1)
  content     String   @db.Text
  clause      Clause   @relation(fields: [clauseId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([clauseId, pointLetter])
  @@index([clauseId])
  @@map("points")
}

model LegalRelationship {
  id               String           @id @default(uuid()) @db.Uuid
  sourceType       EntityType       @map("source_type")
  sourceCanonicalId String          @map("source_canonical_id") @db.VarChar(100)
  targetType       EntityType       @map("target_type")
  targetCanonicalId String          @map("target_canonical_id") @db.VarChar(100)
  relationshipType RelationshipType @map("relationship_type")
  description      String?          @db.Text
  effectiveDate    DateTime?        @map("effective_date") @db.Date
  createdAt        DateTime         @default(now()) @map("created_at")

  @@index([sourceCanonicalId, targetCanonicalId])
  @@index([targetCanonicalId])
  @@map("legal_relationships")
}

model LegalMetadata {
  id                String     @id @default(uuid()) @db.Uuid
  entityType        EntityType @map("entity_type")
  entityCanonicalId String     @map("entity_canonical_id") @db.VarChar(100)
  key               String     @db.VarChar(100)
  value             String     @db.Text
  createdAt         DateTime   @default(now()) @map("created_at")

  @@index([entityCanonicalId])
  @@map("legal_metadata")
}
