generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  editor
}

enum ChangeType {
  amendment
  addition
  first_codification
}

enum ChangeStatus {
  draft
  published
}

enum HeadlineStatus {
  draft
  scheduled
  active
  archived
}

enum CrawledDocumentType {
  law
  amendment
  draft
  policy_direction
}

enum CrawlReviewStatus {
  pending
  reviewed
  published
  rejected
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.Text
  name         String?  @db.VarChar(255)
  role         UserRole @default(editor)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  headlines    HomepageHeadline[]

  @@map("users")
}

model Field {
  id                String                 @id @default(uuid()) @db.Uuid
  name              String                 @db.VarChar(255)
  slug              String                 @unique @db.VarChar(255)
  createdAt         DateTime               @default(now()) @map("created_at")
  updatedAt         DateTime               @updatedAt @map("updated_at")
  regulatoryChanges RegulatoryChangeField[]

  @@map("fields")
}

model RegulatoryChange {
  id               String                 @id @default(uuid()) @db.Uuid
  slug             String                 @unique @db.VarChar(255)
  lawName          String                 @map("law_name") @db.Text
  changeType       ChangeType             @map("change_type")
  legalBasis       String                 @map("legal_basis") @db.Text
  source           String                 @db.Text
  effectiveDate    DateTime               @map("effective_date") @db.Date
  headline         String                 @db.Text
  summary          String                 @db.Text
  practicalImpact  String[]               @map("practical_impact")
  affectedParties  String[]               @map("affected_parties")
  analysisSummary  String?                @map("analysis_summary") @db.Text
  comparisonBefore String?                @map("comparison_before") @db.Text
  comparisonAfter  String?                @map("comparison_after") @db.Text
  timeline         String?                @db.Text
  context          String?                @db.Text
  status           ChangeStatus           @default(draft)
  fields              RegulatoryChangeField[]
  homepageHeadlines   HomepageHeadline[]
  createdAt           DateTime               @default(now()) @map("created_at")
  updatedAt           DateTime               @updatedAt @map("updated_at")

  @@map("regulatory_changes")
}

model RegulatoryChangeField {
  regulatoryChangeId String           @map("regulatory_change_id") @db.Uuid
  fieldId            String           @map("field_id") @db.Uuid
  regulatoryChange   RegulatoryChange @relation(fields: [regulatoryChangeId], references: [id], onDelete: Cascade)
  field              Field            @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@id([regulatoryChangeId, fieldId])
  @@map("regulatory_change_fields")
}

model Member {
  id           String    @id @default(uuid()) @db.Uuid
  email        String    @unique @db.VarChar(255)
  passwordHash String    @map("password_hash") @db.Text
  name         String?   @db.VarChar(255)
  avatarUrl    String?   @map("avatar_url") @db.Text
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@map("members")
}

model HomepageHeadline {
  id                   String         @id @default(uuid()) @db.Uuid
  regulatoryChangeId   String         @map("regulatory_change_id") @db.Uuid
  regulatoryChange     RegulatoryChange @relation(fields: [regulatoryChangeId], references: [id], onDelete: Cascade)
  title                String         @db.Text
  subtitle             String?        @db.Text
  position             Int            @default(0)
  pinned               Boolean        @default(false)
  status               HeadlineStatus @default(draft)
  publishAt            DateTime?      @map("publish_at")
  archiveAt            DateTime?      @map("archive_at")
  createdById          String         @map("created_by_id") @db.Uuid
  createdBy            User           @relation(fields: [createdById], references: [id])
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  @@map("homepage_headlines")
}

model CrawledItem {
  id                     String              @id @default(uuid()) @db.Uuid
  title                  String              @db.Text
  summary                String?             @db.Text
  sourceUrl              String              @unique @map("source_url") @db.Text
  sourceName             String              @map("source_name") @db.VarChar(100)
  publishDate            DateTime?           @map("publish_date")
  documentType           CrawledDocumentType @default(law) @map("document_type")
  isDraft                Boolean             @default(false) @map("is_draft")
  legalFields            String[]            @map("legal_fields")
  affectedSubjects       String[]            @map("affected_subjects")
  consultationStartDate  DateTime?           @map("consultation_start_date")
  consultationEndDate    DateTime?           @map("consultation_end_date")
  draftingAuthority      String?             @map("drafting_authority") @db.VarChar(255)
  expectedApprovalTime   String?             @map("expected_approval_time") @db.VarChar(255)
  reviewStatus           CrawlReviewStatus   @default(pending) @map("review_status")
  editedTitle            String?             @map("edited_title") @db.Text
  editedSummary          String?             @map("edited_summary") @db.Text
  adminNotes             String?             @map("admin_notes") @db.Text
  reviewedAt             DateTime?           @map("reviewed_at")
  rawHtml                String?             @map("raw_html") @db.Text
  crawledAt              DateTime            @default(now()) @map("crawled_at")
  updatedAt              DateTime            @updatedAt @map("updated_at")

  @@index([reviewStatus])
  @@index([sourceName])
  @@index([crawledAt])
  @@map("crawled_items")
}
